<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../flip-card/flip-card.html">

<dom-module id="flip-card-board">
  <template>
    <style>
      :host {
        display: block;
      }
      .remove {
        opacity: 0;
      }
      flip-card {
        transition: opacity 2s ease;
         margin: 3px;
      }

      body {
        height: 100%;
      }

      #container {
        width: 100%;
        height: 100%;
        display: grid;
        grid-template-rows: 33% 33% 33%;
        grid-template-columns: 15% 15% 15% 15% 15% 15%;
        grid-column-align: center;
        grid-row-align: center;  
        /*grid-column-gap: 1em; 
        grid-row-gap: 1em;*/
      }

      .item1 {
        grid-column: 1;
        grid-row: 1;
      }

      .item2 {
        grid-column: 2;
        grid-row: 1;
      }

      .item3 {
        grid-column: 3;
        grid-row: 1;
      }

      .item4 {
        grid-column: 4;
        grid-row: 1;
      }

      .activePlayer:after {
        content: '*';
      }

      .activePlayer {
        color: purple;
      }

      #players {
        display: flex;
        justify-content: space-around;
        align-items: center;
      }

    </style>
    <div id="players">
      <div>
        <h3 id="player1Score" class="activePlayer">Player1: {{player1Score}}</h3>
      </div>

      <div >
        <h3 id="player2Score">Player2: {{player2Score}}</h3>
      </div>
    </div>

    <div id="container">

      <flip-card on-click="cardViewed" class="item1">
        <img id='item1img' style="width:100%;height:100%" src=""></img>
      </flip-card>
      
      <flip-card on-click="cardViewed" class="item2">
        <img id='item2img' style="width:100%;height:100%" src=""></img>
      </flip-card>

      <flip-card on-click="cardViewed" class="item3">        
        <img id='item3img' style="width:100%;height:100%" src=""></img>
      </flip-card>

      <flip-card on-click="cardViewed" class="item4">        
        <img id='item4img' style="width:100%;height:100%" src=""></img>
      </flip-card>

      <flip-card on-click="cardViewed" class="item5">        
        <img id='item5img' style="width:100%;height:100%" src=""></img>
      </flip-card>

      <flip-card on-click="cardViewed" class="item6">
          <img id='item6img' style="width:100%;height:100%" src=""></img>
      </flip-card>

      <flip-card on-click="cardViewed" class="item7">
        <img id='item7img' style="width:100%;height:100%" src=""></img>
      </flip-card>

      <flip-card on-click="cardViewed" class="item8">
        <img id='item8img' style="width:100%;height:100%" src=""></img>
      </flip-card>

      <flip-card on-click="cardViewed" class="item9">
        <img id='item9img' style="width:100%;height:100%" src=""></img>
      </flip-card>

      <flip-card on-click="cardViewed" class="item10">
        <img id='item10img' style="width:100%;height:100%" src=""></img>
      </flip-card>

      <flip-card on-click="cardViewed" class="item11">
        <img id='item11img' style="width:100%;height:100%" src=""></img>
      </flip-card>

      <flip-card on-click="cardViewed" class="item12">
        <img id='item12img' style="width:100%;height:100%" src=""></img>
      </flip-card>

      <flip-card on-click="cardViewed" class="item13">
        <img id='item13img' style="width:100%;height:100%" src=""></img>
      </flip-card>

       <flip-card on-click="cardViewed" class="item14">
        <img id='item14img' style="width:100%;height:100%" src=""></img>
      </flip-card>

       <flip-card on-click="cardViewed" class="item15">
        <img id='item15img' style="width:100%;height:100%" src=""></img>
      </flip-card>

       <flip-card on-click="cardViewed" class="item16">
        <img id='item16img' style="width:100%;height:100%" src=""></img>
      </flip-card>

       <flip-card on-click="cardViewed" class="item17">
        <img id='item17img' style="width:100%;height:100%" src=""></img>
      </flip-card>

       <flip-card on-click="cardViewed" class="item18">
        <img id='item18img' style="width:100%;height:100%" src=""></img>
      </flip-card>
      
      <player-scores></player-scores>
      
    </div>

  </template>
</dom-module>

<script>
  
  class FlipCardBoard extends Polymer.Element {

    constructor() {
      super();
      this.allowNewSelection = true;
      this.numCardsFlipped = 0;
      this.activePlayer = "player1";
      this.player1Score = 0;
      this.player2Score = 0;
    }
    static get config(){ 
      return {
        properties: {
          player1Score : {type: Number},
          player2Score : {type: Number},
          activePlayer: {type: String},
          card1Selected: {type: Object},
          card2Selected: {type: Object},
          numCardsFlipped: {type: Number},
          allowNewSelection: {type: Boolean}
        }
      }
    }

    CheckIfMatchMade() {
      console.log(this.card1Selected.firstElementChild.getAttribute('src'));
      console.log(this.card2Selected.firstElementChild.getAttribute('src'));

      if (this.card1Selected.firstElementChild.getAttribute('src') === this.card2Selected.firstElementChild.getAttribute('src')) {
            console.log('matched!');
            setTimeout( () => {
            this.card1Selected.classList.add('remove');
            this.card2Selected.classList.add('remove');
            this.card1Selected = null;
            this.card2Selected = null;
            this.allowNewSelection = true;
            }, 1000);
            if (this.activePlayer === "player1") {
              this.player1Score += 100;
            }
            else {
              this.player2Score += 100;
            }
          }
          else {
            setTimeout( () => {
            this.card1Selected.FlipMe();
            this.card2Selected.FlipMe();
            this.card1Selected = null;
            this.card2Selected = null;
            this.allowNewSelection = true;
            this.MoveToNextPlayer();
            }, 2000);
        } 
        
    }
          
    MoveToNextPlayer() {
      if (this.activePlayer === "player1") {
          this.activePlayer = "player2";
          this.$.player1Score.classList.toggle('activePlayer')
          this.$.player2Score.classList.toggle('activePlayer')
        }
        else {
          this.activePlayer = "player1";
          this.$.player2Score.classList.toggle('activePlayer')
          this.$.player1Score.classList.toggle('activePlayer')
        }
    }

    cardViewed(e) {

      if (this.card1Selected != null) {
        if (this.card1Selected.firstElementChild === e.target) {
          console.log('Card1 selected again!');
          return;
        }
      }
        
    if (this.card2Selected != null) {
          if (this.card2Selected.firstElementChild === e.target) {
            console.log('Card2 selected again!');
            return;
          }
    }
        

      if (this.allowNewSelection === false) {
        console.log('no more selections allowed!');
        return;
      }

      console.log(this.numCardsFlipped);

      //Record that a card is flipped
      this.numCardsFlipped++;

      // If this is the first card flipped then ensure it does not flip back (pass false)
      if (this.numCardsFlipped === 1) {
        console.log('flip and keep flipped');
        this.card1Selected = e.target;
        e.target.FlipMe(false);
      }
      else  {
        console.log('flip and then unflip with previous card');
        this.card2Selected = e.target;
        this.allowNewSelection = false;
        e.target.FlipMe(false);
        this.numCardsFlipped = 0;
        this.CheckIfMatchMade();
      }
    }

    generateCards(image, usedCards) {

      let validNumber = false;
      let num1 = 0;
      let num2 = 0;

      while (validNumber === false) {
        validNumber = true;
        num1 = Math.floor((Math.random() * 18) + 1)

        for(let index = 0; index < usedCards.length; index++)
        {
          //console.log('checking ' + index)
          if (usedCards[index] === num1)
            validNumber = false;
        }
      }

      usedCards.push(num1);
      validNumber = false;

      while (validNumber === false) {
        validNumber = true;
        num2 = Math.floor((Math.random() * 18) + 1)

        for(let index = 0; index < usedCards.length; index++)
        {
          if (usedCards[index] === num2)
            validNumber = false;
        }

      }
      
      usedCards.push(num2);

      //Do rogue
      let card1 = '#item' + num1 + 'img';
      let card2 = '#item' + num2 + 'img';

      //console.log(card1);
      let nodeCard1 = this.shadowRoot.querySelector(card1);
      nodeCard1.setAttribute("src",`./images/${image}.jpg`);

      //console.log(card2);
      let nodeCard2 = this.shadowRoot.querySelector(card2);
      nodeCard2.setAttribute("src",`./images/${image}.jpg`);

    }

    static get is() {
      return 'flip-card-board';
    }

    connectedCallback() {
      super.connectedCallback();
      let usedCards = [];
      this.generateCards('rogue', usedCards);
      this.generateCards('moo', usedCards);
      this.generateCards('heady', usedCards);
      this.generateCards('kong', usedCards);
      this.generateCards('minion', usedCards);
      this.generateCards('minion', usedCards);
      this.generateCards('minion', usedCards);
      this.generateCards('minion', usedCards);
      this.generateCards('kong', usedCards);
    }
  }

  customElements.define(FlipCardBoard.is, FlipCardBoard);

</script>

